<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026新年贺卡 - 霓虹灯笼丝带福字版</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #000; 
            overflow: hidden; 
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        #scene { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1;
        }
        
        /* 主标题 */
        .main-title {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 4.5rem;
            color: transparent;
            background: linear-gradient(45deg, #FF00FF, #00FFFF, #FFFF00, #FF00FF);
            -webkit-background-clip: text;
            background-clip: text;
            text-shadow: 0 0 50px rgba(255, 0, 255, 0.8);
            z-index: 50;
            letter-spacing: 3px;
            text-align: center;
            animation: neonGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes neonGlow {
            0% {
                text-shadow: 0 0 10px rgba(255, 0, 255, 0.5),
                             0 0 20px rgba(255, 0, 255, 0.3),
                             0 0 30px rgba(255, 0, 255, 0.2);
            }
            100% {
                text-shadow: 0 0 20px rgba(255, 0, 255, 0.8),
                             0 0 40px rgba(255, 0, 255, 0.6),
                             0 0 60px rgba(255, 0, 255, 0.4),
                             0 0 80px rgba(255, 0, 255, 0.2);
            }
        }
        
        .sub-title {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            color: #00FFFF;
            font-size: 1.5rem;
            z-index: 50;
            text-align: center;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
        }
        
        /* 霓虹光晕效果 */
        .neon-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300px;
            height: 300px;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(255,0,255,0.2) 0%, rgba(0,255,255,0.1) 40%, transparent 70%);
            border-radius: 50%;
            filter: blur(60px);
            z-index: 0;
            animation: pulseGlow 4s ease-in-out infinite;
            opacity: 0.7;
        }
        
        @keyframes pulseGlow {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.9; }
        }
        
        /* 设置面板 */
        .settings-panel {
            position: absolute;
            top: 40px;
            left: 40px;
            width: 320px;
            background: rgba(10, 10, 30, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            border: 2px solid rgba(255, 0, 255, 0.4);
            z-index: 100;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4),
                        0 0 30px rgba(255, 0, 255, 0.3);
            color: white;
            transition: all 0.3s;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            color: #FF00FF;
            text-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
        }
        
        .settings-header h3 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .setting-group {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border-left: 3px solid #00FFFF;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }
        
        .setting-label {
            display: block;
            margin-bottom: 10px;
            color: #00FFFF;
            font-size: 1rem;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slider-container input {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #FF00FF, #00FFFF);
            border-radius: 4px;
            outline: none;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
        }
        
        .slider-container input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            border: 2px solid #FF00FF;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.8);
            transition: all 0.3s;
        }
        
        .slider-container input::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(255, 0, 255, 1);
        }
        
        .slider-value {
            color: #FF00FF;
            font-weight: bold;
            min-width: 50px;
            text-align: right;
            text-shadow: 0 0 5px rgba(255, 0, 255, 0.5);
        }
        
        /* 霓虹开关 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
            margin-left: 15px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, #333, #111);
            transition: .4s;
            border-radius: 34px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: linear-gradient(145deg, #fff, #ccc);
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        input:checked + .toggle-slider {
            background: linear-gradient(90deg, #FF00FF, #00FFFF);
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
        }
        
        /* 霓虹按钮 */
        .neon-btn {
            padding: 15px 30px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid transparent;
            border-image: linear-gradient(45deg, #FF00FF, #00FFFF) 1;
            border-radius: 15px;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 20px;
        }
        
        .neon-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 0, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .neon-btn:hover::before {
            left: 100%;
        }
        
        .neon-btn:hover {
            background: rgba(255, 0, 255, 0.1);
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.5),
                        inset 0 0 20px rgba(255, 0, 255, 0.2);
        }
        
        /* 祝福语卡片 */
        .wish-card {
            position: absolute;
            top: 180px;
            right: 40px;
            width: 280px;
            background: rgba(10, 10, 30, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(0, 255, 255, 0.4);
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3),
                        0 0 20px rgba(0, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .wish-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 255, 255, 0.8);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4),
                        0 0 30px rgba(0, 255, 255, 0.5);
        }
        
        .wish-title {
            color: #FF00FF;
            font-size: 1.4rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
        }
        
        .wish-content {
            color: white;
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .wish-author {
            color: rgba(0, 255, 255, 0.7);
            font-size: 0.9rem;
            font-style: italic;
        }
        
        /* 控制按钮 */
        .controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 100;
        }
        
        .control-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid transparent;
            border-image: linear-gradient(45deg, #FF00FF, #00FFFF) 1;
            color: white;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .control-btn:hover {
            transform: scale(1.2);
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.5),
                        inset 0 0 20px rgba(255, 0, 255, 0.2);
        }
        
        .control-btn.active {
            background: rgba(255, 0, 255, 0.2);
            box-shadow: 0 0 40px rgba(255, 0, 255, 0.6);
        }
        
        /* 烟花计数器 */
        .counter {
            position: absolute;
            top: 40px;
            right: 40px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 0, 255, 0.4);
            border-radius: 20px;
            padding: 15px 25px;
            color: #FF00FF;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 100;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3),
                        0 0 15px rgba(255, 0, 255, 0.3);
        }
        
        /* 霓虹加载界面 */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 1s;
        }
        
        .loading .spinner {
            width: 100px;
            height: 100px;
            border: 4px solid transparent;
            border-top: 4px solid #FF00FF;
            border-bottom: 4px solid #00FFFF;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.5);
        }
        
        @keyframes spin {
            0% { 
                transform: rotate(0deg);
                box-shadow: 0 0 30px rgba(255, 0, 255, 0.5);
            }
            50% {
                box-shadow: 0 0 60px rgba(0, 255, 255, 0.8);
            }
            100% { 
                transform: rotate(360deg);
                box-shadow: 0 0 30px rgba(255, 0, 255, 0.5);
            }
        }
        
        .loading-text {
            color: #00FFFF;
            font-size: 1.5rem;
            animation: pulse 2s infinite;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
        }
        
        /* 霓虹数字特效 */
        .neon-number {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, 
                rgba(255,0,255,0.3) 0%,
                rgba(0,255,255,0.2) 30%,
                transparent 70%);
            filter: blur(40px);
            z-index: -1;
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .settings-panel {
                width: 280px;
                left: 20px;
                top: 20px;
                padding: 20px;
            }
            
            .wish-card {
                width: 250px;
                right: 20px;
                top: 150px;
            }
            
            .main-title {
                font-size: 3.5rem;
                top: 30px;
            }
            
            .sub-title {
                top: 100px;
                font-size: 1.2rem;
            }
        }
        
        @media (max-width: 768px) {
            .settings-panel {
                width: 90%;
                left: 5%;
                top: 20px;
            }
            
            .wish-card {
                width: 90%;
                right: 5%;
                top: 180px;
            }
            
            .main-title {
                font-size: 2.8rem;
                top: 20px;
            }
            
            .sub-title {
                top: 85px;
                font-size: 1rem;
            }
            
            .counter {
                top: 20px;
                right: 5%;
                padding: 10px 20px;
            }
            
            .controls {
                bottom: 20px;
                gap: 10px;
            }
            
            .control-btn {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            
            .neon-glow {
                width: 200px;
                height: 200px;
                filter: blur(40px);
            }
        }
    </style>
</head>
<body>
    <!-- 霓虹加载界面 -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">加载 2026 霓虹场景...</div>
        <div class="neon-number"></div>
    </div>
    
    <!-- 霓虹背景光晕 -->
    <div class="neon-glow"></div>
    
    <!-- 3D场景容器 -->
    <div id="scene"></div>
    
    <!-- 主标题 -->
    <div class="main-title">2026</div>
    <div class="sub-title">新年快乐 · 万事如意</div>
    
    <!-- 烟花计数器 -->
    <div class="counter" id="counter">
        <i class="fas fa-fire"></i>
        <span>烟花: <span id="fireworkCount">0</span></span>
    </div>
    
    <!-- 设置面板 -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h3><i class="fas fa-cog"></i>霓虹设置</h3>
        </div>
        
        <div class="setting-group">
            <label class="setting-label">
                霓虹强度: <span class="slider-value" id="neonIntensityValue">2.0</span>
            </label>
            <div class="slider-container">
                <input type="range" min="0.5" max="5" step="0.1" value="2.0" 
                       id="neonIntensitySlider">
            </div>
        </div>
        
        <div class="setting-group">
            <label class="setting-label">
                丝带速度: <span class="slider-value" id="ribbonSpeedValue">0.8</span>
            </label>
            <div class="slider-container">
                <input type="range" min="0" max="2" step="0.1" value="0.8" 
                       id="ribbonSpeedSlider">
            </div>
        </div>
        
        <div class="setting-group">
            <label class="setting-label">
                福字亮度: <span class="slider-value" id="fuCharacterBrightnessValue">3.0</span>
            </label>
            <div class="slider-container">
                <input type="range" min="1" max="5" step="0.1" value="3.0" 
                       id="fuCharacterBrightnessSlider">
            </div>
        </div>
        
        <div class="setting-group">
            <label class="setting-label">
                辉光半径: <span class="slider-value" id="glowRadiusValue">15</span>
            </label>
            <div class="slider-container">
                <input type="range" min="5" max="30" step="1" value="15" 
                       id="glowRadiusSlider">
            </div>
        </div>
        
        <div class="setting-group">
            <label class="setting-label">
                闪烁速度: <span class="slider-value" id="blinkSpeedValue">1.5</span>
            </label>
            <div class="slider-container">
                <input type="range" min="0.5" max="3" step="0.1" value="1.5" 
                       id="blinkSpeedSlider">
            </div>
        </div>
        
        <div class="setting-group">
            <label class="setting-label">
                颜色模式: <span class="slider-value" id="colorModeValue">多彩</span>
            </label>
            <div class="slider-container">
                <input type="range" min="1" max="3" step="1" value="2" 
                       id="colorModeSlider">
            </div>
        </div>
        
        <div class="setting-group" style="display: flex; align-items: center; justify-content: space-between;">
            <span class="setting-label">霓虹光晕</span>
            <label class="toggle-switch">
                <input type="checkbox" id="neonGlowToggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="setting-group" style="display: flex; align-items: center; justify-content: space-between;">
            <span class="setting-label">丝带动画</span>
            <label class="toggle-switch">
                <input type="checkbox" id="ribbonAnimationToggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="setting-group" style="display: flex; align-items: center; justify-content: space-between;">
            <span class="setting-label">福字旋转</span>
            <label class="toggle-switch">
                <input type="checkbox" id="fuRotationToggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="setting-group" style="display: flex; align-items: center; justify-content: space-between;">
            <span class="setting-label">动态闪烁</span>
            <label class="toggle-switch">
                <input type="checkbox" id="blinkToggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="setting-group" style="display: flex; align-items: center; justify-content: space-between;">
            <span class="setting-label">自动旋转</span>
            <label class="toggle-switch">
                <input type="checkbox" id="autoRotateToggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <button class="neon-btn" onclick="applySettings()">
            <i class="fas fa-bolt"></i>应用设置
        </button>
    </div>
    
    <!-- 祝福语卡片 -->
    <div class="wish-card" id="wishCard" onclick="nextWish()">
        <div class="wish-title">
            <i class="fas fa-star"></i>
            <span id="wishTitle">新年祝福</span>
        </div>
        <div class="wish-content" id="wishContent">
            愿2026年带给你健康、幸福和成功
        </div>
        <div class="wish-author" id="wishAuthor">- 点击切换祝福 -</div>
    </div>
    
    <!-- 控制按钮 -->
    <div class="controls">
        <button class="control-btn" onclick="launchNeonFireworks()" title="发射霓虹烟花">
            <i class="fas fa-bolt"></i>
        </button>
        <button class="control-btn" onclick="toggleAutoRotate()" id="rotateBtn" title="旋转控制">
            <i class="fas fa-pause"></i>
        </button>
        <button class="control-btn" onclick="resetView()" title="重置视角">
            <i class="fas fa-redo"></i>
        </button>
        <button class="control-btn" onclick="toggleMusic()" id="musicBtn" title="音乐">
            <i class="fas fa-play"></i>
        </button>
        <button class="control-btn" onclick="toggleNeonMode()" id="neonBtn" title="霓虹模式">
            <i class="fas fa-lightbulb"></i>
        </button>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    
    <script>
        // ====== 全局变量 ======
        let scene, camera, renderer, controls;
        let lanterns = [];
        let neonParticles = [];
        let neonLights = [];
        let neonRibbons = [];
        let fuCharacterGroup = null;
        let isAutoRotating = true;
        let fireworkCount = 0;
        let audio = null;
        let isMusicPlaying = false;
        let isNeonMode = true;
        
        // 霓虹设置
        let neonIntensity = 2.0;
        let glowRadius = 15;
        let blinkSpeed = 1.5;
        let colorMode = 2; // 1:单色, 2:多彩, 3:彩虹
        let isNeonGlow = true;
        let isBlinking = true;
        
        // 丝带设置
        let ribbonSpeed = 0.8;
        let isRibbonAnimating = true;
        
        // 福字设置
        let fuCharacterBrightness = 3.0;
        let isFuRotating = true;
        
        // 霓虹颜色方案
        const neonColors = [
            [0xFF00FF, 0x00FFFF], // 洋红-青色
            [0x00FF00, 0xFF0000], // 绿-红
            [0xFFFF00, 0xFF00FF], // 黄-洋红
            [0x00FFFF, 0x00FF00], // 青-绿
            [0xFF0000, 0xFFFF00], // 红-黄
        ];
        
        // 彩虹颜色
        const rainbowColors = [
            0xFF0000, 0xFF7F00, 0xFFFF00, 0x00FF00, 
            0x0000FF, 0x4B0082, 0x8F00FF
        ];
        
        // 祝福语
        const wishes = [
            {
                title: "新年快乐",
                content: "2026年，愿你的每一天都充满阳光，每一步都走向辉煌！新的一年，新的起点，愿你心想事成，万事如意！",
                author: "新年祝福"
            },
            {
                title: "万事如意",
                content: "愿新的一年里，你所有的希望都能如愿，所有的梦想都能实现！事业顺利，家庭美满，身体健康！",
                author: "美好祝愿"
            },
            {
                title: "阖家幸福",
                content: "祝福您和家人在2026年：身体健康，工作顺利，生活美满！团团圆圆，幸福安康！",
                author: "温馨祝福"
            },
            {
                title: "前程似锦",
                content: "愿2026年的你，事业如日中天，前程似锦，步步高升！实现所有目标，收获更多成功！",
                author: "事业祝福"
            },
            {
                title: "心想事成",
                content: "新的一年，愿你所想皆所得，所愿皆实现，每一天都充满惊喜！快乐永驻，幸福常伴！",
                author: "心愿祝福"
            }
        ];
        let wishIndex = 0;
        
        // ====== 初始化 ======
        function init() {
            console.log("正在初始化霓虹场景...");
            
            try {
                // 创建场景
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x000000);
                scene.fog = new THREE.Fog(0x000000, 10, 150);
                
                // 创建相机
                camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
                camera.position.set(0, 20, 45);
                
                // 创建渲染器
                renderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    alpha: false,
                    powerPreference: "high-performance"
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                renderer.outputEncoding = THREE.sRGBEncoding;
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 1.2;
                
                document.getElementById('scene').appendChild(renderer.domElement);
                
                // 创建轨道控制
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.maxDistance = 100;
                controls.minDistance = 15;
                
                // 设置霓虹环境
                setupNeonEnvironment();
                
                // 创建场景元素
                createNeonGround();
                createNeonYear2026();
                createNeonLanterns();
                createFixedRibbons(); // 使用修复后的丝带创建函数
                createFuCharacter(); // 创建福字
                createNeonParticles();
                createNeonLightStreaks();
                
                // 更新UI
                updateWish();
                updateFireworkCount();
                
                // 事件监听
                setupEventListeners();
                
                // 动画循环
                animate();
                
                // 完成加载
                setTimeout(() => {
                    document.getElementById('loading').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loading').style.display = 'none';
                        
                        // 自动发射霓虹烟花
                        setTimeout(() => {
                            launchNeonFireworks(3);
                        }, 1000);
                        
                        console.log("霓虹场景加载完成！");
                        
                    }, 1000);
                }, 2000);
                
            } catch (error) {
                console.error("初始化失败:", error);
                document.getElementById('loading').innerHTML = `
                    <div style="color:#FF00FF; text-align:center; padding:40px;">
                        <h2>加载遇到问题</h2>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" style="
                            margin-top:20px;
                            padding:12px 30px;
                            background:linear-gradient(145deg, #FF00FF, #00FFFF);
                            border:none;
                            border-radius:25px;
                            color:#000;
                            font-weight:bold;
                            cursor:pointer;">
                            重新加载
                        </button>
                    </div>
                `;
            }
        }
        
        // ====== 设置霓虹环境 ======
        function setupNeonEnvironment() {
            // 深色背景
            scene.background = new THREE.Color(0x000011);
            
            // 环境光 - 使用霓虹色调
            const ambientLight = new THREE.AmbientLight(0x220033, 0.6);
            scene.add(ambientLight);
            
            // 主霓虹光
            const neonLight = new THREE.PointLight(0xFF00FF, 2, 50);
            neonLight.position.set(0, 30, 0);
            neonLight.castShadow = true;
            scene.add(neonLight);
            
            // 辅助霓虹光
            const cyanLight = new THREE.PointLight(0x00FFFF, 1.5, 50);
            cyanLight.position.set(30, 20, 10);
            scene.add(cyanLight);
            
            const yellowLight = new THREE.PointLight(0xFFFF00, 1.5, 50);
            yellowLight.position.set(-30, 20, -10);
            scene.add(yellowLight);
            
            // 添加彩虹点光源
            for (let i = 0; i < 8; i++) {
                const color = rainbowColors[i % rainbowColors.length];
                const pointLight = new THREE.PointLight(color, 0.8, 40);
                pointLight.position.set(
                    (Math.random() - 0.5) * 60,
                    Math.random() * 30 + 10,
                    (Math.random() - 0.5) * 60
                );
                pointLight.userData = {
                    originalY: pointLight.position.y,
                    pulseSpeed: 0.5 + Math.random() * 1.5,
                    pulseOffset: Math.random() * Math.PI * 2
                };
                scene.add(pointLight);
                neonLights.push(pointLight);
            }
        }
        
        // ====== 创建霓虹地面 ======
        function createNeonGround() {
            // 主地面
            const groundGeometry = new THREE.CircleGeometry(100, 128);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x110022,
                roughness: 0.8,
                metalness: 0.3,
                emissive: 0x220033,
                emissiveIntensity: 0.3
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -5;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // 霓虹反射层
            const reflectionGeometry = new THREE.CircleGeometry(100, 128);
            const reflectionMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x00FFFF,
                transparent: true,
                opacity: 0.1,
                blending: THREE.AdditiveBlending
            });
            const reflection = new THREE.Mesh(reflectionGeometry, reflectionMaterial);
            reflection.rotation.x = -Math.PI / 2;
            reflection.position.y = -4.9;
            scene.add(reflection);
        }
        
        // ====== 创建霓虹2026数字 ======
        function createNeonYear2026() {
            const numbers = [
                { value: '2', color: 0xFF00FF, position: [-9, 8, 0] },
                { value: '0', color: 0x00FFFF, position: [-3, 8, 0] },
                { value: '2', color: 0xFFFF00, position: [3, 8, 0] },
                { value: '6', color: 0xFF4500, position: [9, 8, 0] }
            ];
            
            numbers.forEach((num, index) => {
                // 数字主体
                const geometry = new THREE.BoxGeometry(3.5, 5, 0.8);
                const material = new THREE.MeshPhongMaterial({ 
                    color: num.color,
                    emissive: num.color,
                    emissiveIntensity: neonIntensity,
                    shininess: 30,
                    transparent: true,
                    opacity: 0.9
                });
                const number = new THREE.Mesh(geometry, material);
                number.position.set(num.position[0], num.position[1], num.position[2]);
                number.castShadow = true;
                
                // 数字光晕
                const glowGeometry = new THREE.SphereGeometry(2, 32, 32);
                const glowMaterial = new THREE.MeshBasicMaterial({
                    color: num.color,
                    transparent: true,
                    opacity: 0.3,
                    blending: THREE.AdditiveBlending,
                    side: THREE.BackSide
                });
                const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                glow.position.set(num.position[0], num.position[1], num.position[2]);
                scene.add(glow);
                
                // 添加霓虹灯光
                const light = new THREE.PointLight(num.color, neonIntensity * 2, glowRadius);
                light.position.set(num.position[0], num.position[1], num.position[2]);
                scene.add(light);
                
                // 添加动画数据
                number.userData = {
                    originalY: num.position[1],
                    pulseOffset: Math.random() * Math.PI * 2,
                    pulseSpeed: blinkSpeed,
                    glow: glow,
                    light: light
                };
                
                glow.userData = {
                    pulseOffset: Math.random() * Math.PI * 2,
                    pulseSpeed: blinkSpeed * 0.7
                };
                
                scene.add(number);
            });
        }
        
        // ====== 创建霓虹灯笼 ======
        function createNeonLanterns() {
            const lanternCount = 12;
            
            for (let i = 0; i < lanternCount; i++) {
                const angle = (i / lanternCount) * Math.PI * 2;
                const radius = 25;
                
                // 灯笼组
                const lantern = new THREE.Group();
                
                // 选择霓虹颜色
                const colors = neonColors[i % neonColors.length];
                const mainColor = colors[0];
                const accentColor = colors[1];
                
                // 灯笼骨架 - 霓虹管效果
                const frameGeometry = new THREE.TorusGeometry(1.2, 0.15, 16, 32);
                const frameMaterial = new THREE.MeshPhongMaterial({ 
                    color: mainColor,
                    emissive: mainColor,
                    emissiveIntensity: neonIntensity,
                    shininess: 100,
                    transparent: true,
                    opacity: 0.9
                });
                
                // 顶部骨架
                const topFrame = new THREE.Mesh(frameGeometry, frameMaterial);
                topFrame.position.y = 2.8;
                lantern.add(topFrame);
                
                // 中部骨架
                const middleFrame = new THREE.Mesh(frameGeometry, frameMaterial);
                middleFrame.position.y = 1.4;
                middleFrame.scale.set(0.9, 0.9, 0.9);
                lantern.add(middleFrame);
                
                // 底部骨架
                const bottomFrame = new THREE.Mesh(frameGeometry, frameMaterial);
                bottomFrame.position.y = 0;
                bottomFrame.scale.set(0.8, 0.8, 0.8);
                lantern.add(bottomFrame);
                
                // 灯笼纸 - 霓虹发光效果
                const lanternPaperGeometry = new THREE.SphereGeometry(1.1, 32, 32, 0, Math.PI * 2, 0, Math.PI);
                const lanternPaperMaterial = new THREE.MeshPhongMaterial({
                    color: accentColor,
                    emissive: accentColor,
                    emissiveIntensity: neonIntensity * 0.8,
                    transparent: true,
                    opacity: 0.7,
                    side: THREE.DoubleSide
                });
                const lanternPaper = new THREE.Mesh(lanternPaperGeometry, lanternPaperMaterial);
                lanternPaper.position.y = 1.4;
                lanternPaper.scale.set(1, 1.8, 1);
                lanternPaper.castShadow = true;
                lantern.add(lanternPaper);
                
                // 灯笼光晕
                const glowGeometry = new THREE.SphereGeometry(1.8, 32, 32);
                const glowMaterial = new THREE.MeshBasicMaterial({
                    color: mainColor,
                    transparent: true,
                    opacity: 0.2,
                    blending: THREE.AdditiveBlending,
                    side: THREE.BackSide
                });
                const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                glow.position.y = 1.4;
                glow.scale.set(1, 1.8, 1);
                lantern.add(glow);
                
                // 霓虹灯光
                const lanternLight = new THREE.PointLight(mainColor, neonIntensity * 1.5, glowRadius);
                lanternLight.position.set(0, 1.4, 0);
                lanternLight.castShadow = true;
                lantern.add(lanternLight);
                
                // 灯笼穗子
                const tasselGroup = new THREE.Group();
                const tasselGeometry = new THREE.ConeGeometry(0.08, 1.8, 8);
                const tasselMaterial = new THREE.MeshPhongMaterial({ 
                    color: accentColor,
                    emissive: accentColor,
                    emissiveIntensity: neonIntensity * 0.6
                });
                const mainTassel = new THREE.Mesh(tasselGeometry, tasselMaterial);
                mainTassel.position.y = -1.2;
                mainTassel.rotation.x = Math.PI;
                tasselGroup.add(mainTassel);
                
                lantern.add(tasselGroup);
                
                // 设置灯笼位置
                lantern.position.set(
                    Math.cos(angle) * radius,
                    12 + Math.sin(angle * 2) * 2,
                    Math.sin(angle) * radius
                );
                
                // 添加动画数据
                lantern.userData = {
                    originalY: lantern.position.y,
                    swingSpeed: 0.3 + Math.random() * 0.4,
                    rotateSpeed: 0.02 + Math.random() * 0.03,
                    swingOffset: Math.random() * Math.PI * 2,
                    floatOffset: Math.random() * Math.PI * 2,
                    pulseOffset: Math.random() * Math.PI * 2,
                    pulseSpeed: blinkSpeed,
                    glow: glow,
                    light: lanternLight,
                    mainColor: mainColor,
                    accentColor: accentColor
                };
                
                scene.add(lantern);
                lanterns.push(lantern);
                
                // 创建地面霓虹倒影
                createNeonReflection(lantern, i, angle, radius);
            }
        }
        
        // ====== 创建福字 ======
        function createFuCharacter() {
            fuCharacterGroup = new THREE.Group();
            
            // 福字基座
            const baseGeometry = new THREE.BoxGeometry(8, 0.5, 8);
            const baseMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xFF0000,
                emissive: 0xFF0000,
                emissiveIntensity: fuCharacterBrightness * 0.5,
                shininess: 30,
                transparent: true,
                opacity: 0.9
            });
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            base.position.set(0, 0, 0);
            fuCharacterGroup.add(base);
            
            // 福字基座光晕
            const baseGlowGeometry = new THREE.BoxGeometry(9, 1, 9);
            const baseGlowMaterial = new THREE.MeshBasicMaterial({
                color: 0xFF0000,
                transparent: true,
                opacity: 0.2,
                blending: THREE.AdditiveBlending,
                side: THREE.BackSide
            });
            const baseGlow = new THREE.Mesh(baseGlowGeometry, baseGlowMaterial);
            baseGlow.position.set(0, 0, 0);
            fuCharacterGroup.add(baseGlow);
            
            // 创建福字的笔画 - 使用立方体组合
            createFuCharacterStrokes();
            
            // 福字中心装饰
            const centerOrbGeometry = new THREE.SphereGeometry(0.8, 32, 32);
            const centerOrbMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xFFFF00,
                emissive: 0xFFFF00,
                emissiveIntensity: fuCharacterBrightness * 1.5,
                shininess: 50,
                transparent: true,
                opacity: 0.9
            });
            const centerOrb = new THREE.Mesh(centerOrbGeometry, centerOrbMaterial);
            centerOrb.position.set(0, 2, 0);
            fuCharacterGroup.add(centerOrb);
            
            // 中心装饰光晕
            const centerGlowGeometry = new THREE.SphereGeometry(1.2, 32, 32);
            const centerGlowMaterial = new THREE.MeshBasicMaterial({
                color: 0xFFFF00,
                transparent: true,
                opacity: 0.3,
                blending: THREE.AdditiveBlending,
                side: THREE.BackSide
            });
            const centerGlow = new THREE.Mesh(centerGlowGeometry, centerGlowMaterial);
            centerGlow.position.set(0, 2, 0);
            fuCharacterGroup.add(centerGlow);
            
            // 福字顶部装饰
            const topOrnamentGeometry = new THREE.TorusGeometry(2, 0.2, 16, 32);
            const topOrnamentMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xFF00FF,
                emissive: 0xFF00FF,
                emissiveIntensity: fuCharacterBrightness,
                shininess: 40,
                transparent: true,
                opacity: 0.9
            });
            const topOrnament = new THREE.Mesh(topOrnamentGeometry, topOrnamentMaterial);
            topOrnament.position.set(0, 4.5, 0);
            topOrnament.rotation.x = Math.PI / 2;
            fuCharacterGroup.add(topOrnament);
            
            // 福字灯光
            const fuLight = new THREE.PointLight(0xFF0000, fuCharacterBrightness * 2, 20);
            fuLight.position.set(0, 2, 0);
            fuCharacterGroup.add(fuLight);
            
            // 福字位置
            fuCharacterGroup.position.set(0, 10, 0);
            
            // 添加动画数据
            fuCharacterGroup.userData = {
                rotateSpeed: 0.02,
                pulseOffset: Math.random() * Math.PI * 2,
                pulseSpeed: blinkSpeed * 0.5,
                floatOffset: Math.random() * Math.PI * 2,
                floatSpeed: 0.3
            };
            
            scene.add(fuCharacterGroup);
        }
        
        // ====== 创建福字笔画 ======
        function createFuCharacterStrokes() {
            // 福字的主要笔画
            const strokes = [
                // 顶部横
                { position: [0, 4, 0], size: [3, 0.3, 0.2], color: 0xFF0000 },
                // 左侧竖
                { position: [-1.3, 3, 0], size: [0.2, 2, 0.2], color: 0xFF0000 },
                // 右侧竖
                { position: [1.3, 3, 0], size: [0.2, 2, 0.2], color: 0xFF0000 },
                // 中间横
                { position: [0, 3, 0], size: [2, 0.3, 0.2], color: 0xFF0000 },
                // 底部横
                { position: [0, 1.8, 0], size: [3, 0.3, 0.2], color: 0xFF0000 },
                // 左侧斜
                { position: [-0.8, 2.4, 0], size: [0.2, 1.5, 0.2], color: 0xFF0000, rotation: [0, 0, Math.PI/6] },
                // 右侧斜
                { position: [0.8, 2.4, 0], size: [0.2, 1.5, 0.2], color: 0xFF0000, rotation: [0, 0, -Math.PI/6] },
                // 中间竖
                { position: [0, 2.5, 0], size: [0.2, 1, 0.2], color: 0xFF0000 },
                // 田字左上横
                { position: [-0.6, 1.2, 0], size: [0.8, 0.2, 0.2], color: 0xFF0000 },
                // 田字右上横
                { position: [0.6, 1.2, 0], size: [0.8, 0.2, 0.2], color: 0xFF0000 },
                // 田字左下横
                { position: [-0.6, 0.6, 0], size: [0.8, 0.2, 0.2], color: 0xFF0000 },
                // 田字右下横
                { position: [0.6, 0.6, 0], size: [0.8, 0.2, 0.2], color: 0xFF0000 },
                // 田字左竖
                { position: [-1, 0.9, 0], size: [0.2, 0.8, 0.2], color: 0xFF0000 },
                // 田字右竖
                { position: [1, 0.9, 0], size: [0.2, 0.8, 0.2], color: 0xFF0000 },
                // 田字中竖
                { position: [0, 0.9, 0], size: [0.2, 0.8, 0.2], color: 0xFF0000 },
            ];
            
            strokes.forEach((stroke, index) => {
                const geometry = new THREE.BoxGeometry(...stroke.size);
                const material = new THREE.MeshPhongMaterial({ 
                    color: stroke.color,
                    emissive: stroke.color,
                    emissiveIntensity: fuCharacterBrightness,
                    shininess: 30,
                    transparent: true,
                    opacity: 0.9
                });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(...stroke.position);
                
                if (stroke.rotation) {
                    mesh.rotation.set(...stroke.rotation);
                }
                
                // 笔画光晕
                const glowGeometry = new THREE.BoxGeometry(
                    stroke.size[0] + 0.1, 
                    stroke.size[1] + 0.1, 
                    stroke.size[2] + 0.1
                );
                const glowMaterial = new THREE.MeshBasicMaterial({
                    color: stroke.color,
                    transparent: true,
                    opacity: 0.2,
                    blending: THREE.AdditiveBlending,
                    side: THREE.BackSide
                });
                const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                glow.position.set(...stroke.position);
                
                if (stroke.rotation) {
                    glow.rotation.set(...stroke.rotation);
                }
                
                // 添加动画数据
                mesh.userData = {
                    pulseOffset: Math.random() * Math.PI * 2,
                    pulseSpeed: blinkSpeed * (0.5 + Math.random() * 0.5),
                    glow: glow
                };
                
                glow.userData = {
                    pulseOffset: Math.random() * Math.PI * 2,
                    pulseSpeed: blinkSpeed * (0.5 + Math.random() * 0.5)
                };
                
                fuCharacterGroup.add(mesh);
                fuCharacterGroup.add(glow);
            });
        }
        
        // ====== 修复的丝带创建函数 ======
        function createFixedRibbons() {
            const ribbonCount = 8;
            
            for (let i = 0; i < ribbonCount; i++) {
                const angle = (i / ribbonCount) * Math.PI * 2;
                const radius = 30;
                
                // 选择霓虹颜色
                const colors = neonColors[i % neonColors.length];
                const ribbonColor = colors[0];
                const highlightColor = colors[1];
                
                // 创建更简单的丝带几何体 - 使用扁平的立方体
                const ribbonGeometry = new THREE.BoxGeometry(0.2, 20, 0.05);
                const ribbonMaterial = new THREE.MeshPhongMaterial({ 
                    color: ribbonColor,
                    emissive: ribbonColor,
                    emissiveIntensity: neonIntensity * 0.7,
                    shininess: 50,
                    transparent: true,
                    opacity: 0.9,
                    side: THREE.DoubleSide
                });
                
                const ribbon = new THREE.Mesh(ribbonGeometry, ribbonMaterial);
                
                // 设置丝带位置和旋转
                const ribbonRadius = 20;
                ribbon.position.set(
                    Math.cos(angle) * ribbonRadius,
                    10,
                    Math.sin(angle) * ribbonRadius
                );
                ribbon.rotation.y = angle + Math.PI/2;
                
                // 丝带光晕 - 使用平面
                const glowGeometry = new THREE.PlaneGeometry(0.4, 21);
                const glowMaterial = new THREE.MeshBasicMaterial({
                    color: highlightColor,
                    transparent: true,
                    opacity: 0.2,
                    blending: THREE.AdditiveBlending,
                    side: THREE.DoubleSide
                });
                const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                glow.position.copy(ribbon.position);
                glow.rotation.copy(ribbon.rotation);
                
                // 丝带结 - 简化版
                const knotGeometry = new THREE.TorusGeometry(0.4, 0.15, 16, 32);
                const knotMaterial = new THREE.MeshPhongMaterial({ 
                    color: highlightColor,
                    emissive: highlightColor,
                    emissiveIntensity: neonIntensity,
                    shininess: 30,
                    transparent: true,
                    opacity: 0.9
                });
                const knot = new THREE.Mesh(knotGeometry, knotMaterial);
                knot.position.set(0, 20, 0);
                
                // 丝带结光晕
                const knotGlowGeometry = new THREE.SphereGeometry(0.6, 16, 16);
                const knotGlowMaterial = new THREE.MeshBasicMaterial({
                    color: ribbonColor,
                    transparent: true,
                    opacity: 0.3,
                    blending: THREE.AdditiveBlending
                });
                const knotGlow = new THREE.Mesh(knotGlowGeometry, knotGlowMaterial);
                knotGlow.position.copy(knot.position);
                
                // 添加动画数据
                ribbon.userData = {
                    rotateSpeed: (0.01 + Math.random() * 0.02) * ribbonSpeed,
                    waveSpeed: 0.5 + Math.random() * 0.5,
                    waveAmplitude: 0.1 + Math.random() * 0.2,
                    offset: Math.random() * Math.PI * 2,
                    originalPosition: ribbon.position.clone(),
                    pulseOffset: Math.random() * Math.PI * 2,
                    pulseSpeed: blinkSpeed * 0.8,
                    originalRotation: ribbon.rotation.clone()
                };
                
                glow.userData = {
                    pulseOffset: Math.random() * Math.PI * 2,
                    pulseSpeed: blinkSpeed * 0.7
                };
                
                knot.userData = {
                    rotateSpeed: (0.02 + Math.random() * 0.03) * ribbonSpeed,
                    floatSpeed: 0.3 + Math.random() * 0.3,
                    floatAmplitude: 0.1,
                    offset: Math.random() * Math.PI * 2,
                    pulseOffset: Math.random() * Math.PI * 2,
                    pulseSpeed: blinkSpeed
                };
                
                knotGlow.userData = {
                    pulseOffset: Math.random() * Math.PI * 2,
                    pulseSpeed: blinkSpeed * 0.6
                };
                
                scene.add(ribbon);
                scene.add(glow);
                scene.add(knot);
                scene.add(knotGlow);
                
                neonRibbons.push({
                    ribbon: ribbon,
                    glow: glow,
                    knot: knot,
                    knotGlow: knotGlow,
                    color: ribbonColor,
                    highlightColor: highlightColor
                });
            }
        }
        
        // ====== 创建霓虹倒影 ======
        function createNeonReflection(lantern, index, angle, radius) {
            const colors = neonColors[index % neonColors.length];
            const mainColor = colors[0];
            
            // 霓虹光晕倒影
            const reflectionGeometry = new THREE.CircleGeometry(2.5, 32);
            const reflectionMaterial = new THREE.MeshBasicMaterial({
                color: mainColor,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.4 * neonIntensity * 0.5,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            
            const reflection = new THREE.Mesh(reflectionGeometry, reflectionMaterial);
            reflection.rotation.x = -Math.PI / 2;
            reflection.position.set(
                Math.cos(angle) * radius,
                -4.9,
                Math.sin(angle) * radius
            );
            
            scene.add(reflection);
            
            // 霓虹激光效果
            const laserGeometry = new THREE.CylinderGeometry(0.05, 0.05, 20, 8);
            const laserMaterial = new THREE.MeshBasicMaterial({
                color: mainColor,
                transparent: true,
                opacity: 0.3,
                blending: THREE.AdditiveBlending
            });
            const laser = new THREE.Mesh(laserGeometry, laserMaterial);
            laser.position.set(
                Math.cos(angle) * radius,
                5,
                Math.sin(angle) * radius
            );
            laser.rotation.x = Math.PI / 2;
            scene.add(laser);
            
            // 存储引用
            lantern.userData.reflection = reflection;
            lantern.userData.laser = laser;
            reflection.userData = {
                originalOpacity: 0.4 * neonIntensity * 0.5,
                angle: angle,
                radius: radius,
                pulseSpeed: 0.5 + Math.random() * 0.5,
                pulseOffset: Math.random() * Math.PI * 2
            };
            
            laser.userData = {
                pulseSpeed: 0.3 + Math.random() * 0.4,
                pulseOffset: Math.random() * Math.PI * 2
            };
        }
        
        // ====== 创建霓虹粒子 ======
        function createNeonParticles() {
            const particleCount = 200;
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];
            const sizes = [];
            
            for (let i = 0; i < particleCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const radius = 35 + Math.random() * 15;
                const height = Math.random() * 20;
                
                positions.push(
                    Math.cos(angle) * radius,
                    height,
                    Math.sin(angle) * radius
                );
                
                // 随机霓虹颜色
                const colorSet = neonColors[Math.floor(Math.random() * neonColors.length)];
                const color = colorSet[Math.floor(Math.random() * 2)];
                const threeColor = new THREE.Color(color);
                
                colors.push(threeColor.r, threeColor.g, threeColor.b);
                sizes.push(0.1 + Math.random() * 0.3);
            }
            
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
            
            const material = new THREE.PointsMaterial({
                size: 0.3,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending,
                sizeAttenuation: true
            });
            
            const particles = new THREE.Points(geometry, material);
            scene.add(particles);
            
            particles.userData = {
                positions: positions,
                originalSizes: sizes.slice(),
                pulseSpeeds: new Array(particleCount).fill(0).map(() => 0.5 + Math.random() * 1.5),
                pulseOffsets: new Array(particleCount).fill(0).map(() => Math.random() * Math.PI * 2),
                orbitSpeeds: new Array(particleCount).fill(0).map(() => 0.01 + Math.random() * 0.05),
                orbitAngles: new Array(particleCount).fill(0).map(() => Math.random() * Math.PI * 2),
                floatSpeeds: new Array(particleCount).fill(0).map(() => 0.1 + Math.random() * 0.3)
            };
            
            neonParticles.push(particles);
        }
        
        // ====== 创建霓灯光束 ======
        function createNeonLightStreaks() {
            const streakCount = 8;
            
            for (let i = 0; i < streakCount; i++) {
                const colorSet = neonColors[i % neonColors.length];
                const color = colorSet[0];
                
                // 光束几何体
                const geometry = new THREE.CylinderGeometry(0.05, 0.05, 40, 8);
                const material = new THREE.MeshBasicMaterial({
                    color: color,
                    transparent: true,
                    opacity: 0.2,
                    blending: THREE.AdditiveBlending,
                    side: THREE.DoubleSide
                });
                
                const streak = new THREE.Mesh(geometry, material);
                const angle = (i / streakCount) * Math.PI * 2;
                
                streak.position.set(
                    Math.cos(angle) * 10,
                    20,
                    Math.sin(angle) * 10
                );
                streak.rotation.x = Math.PI / 2;
                streak.rotation.z = angle;
                
                streak.userData = {
                    angle: angle,
                    pulseSpeed: 0.2 + Math.random() * 0.3,
                    pulseOffset: Math.random() * Math.PI * 2,
                    rotateSpeed: 0.01 + Math.random() * 0.02
                };
                
                scene.add(streak);
                neonParticles.push(streak);
            }
        }
        
        // ====== 霓虹烟花系统 ======
        function launchNeonFireworks(count = 1) {
            const fireworkPower = 3;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const x = (Math.random() - 0.5) * 35;
                    const z = (Math.random() - 0.5) * 35;
                    createNeonFirework(x, 10, z, fireworkPower);
                    
                    // 更新计数器
                    fireworkCount++;
                    updateFireworkCount();
                    
                }, i * 150);
            }
        }
        
        function createNeonFirework(x, y, z, power) {
            const particleCount = 200 + power * 100;
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];
            
            // 根据颜色模式选择颜色
            let colorScheme;
            switch(colorMode) {
                case 1: // 单色
                    colorScheme = [0xFF00FF, 0xFF00FF];
                    break;
                case 2: // 多彩
                    colorScheme = neonColors[Math.floor(Math.random() * neonColors.length)];
                    break;
                case 3: // 彩虹
                    const color1 = rainbowColors[Math.floor(Math.random() * rainbowColors.length)];
                    const color2 = rainbowColors[(Math.floor(Math.random() * rainbowColors.length) + 1) % rainbowColors.length];
                    colorScheme = [color1, color2];
                    break;
            }
            
            const velocities = [];
            
            for (let i = 0; i < particleCount; i++) {
                positions.push(x, y, z);
                
                // 随机选择颜色
                const useMain = Math.random() > 0.5;
                const color = useMain ? colorScheme[0] : colorScheme[1];
                
                colors.push(
                    (color >> 16 & 255) / 255,
                    (color >> 8 & 255) / 255,
                    (color & 255) / 255
                );
                
                // 球形爆炸方向
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                const speed = 0.4 + Math.random() * 0.6;
                
                velocities.push({
                    x: Math.sin(phi) * Math.cos(theta) * speed,
                    y: Math.cos(phi) * speed,
                    z: Math.sin(phi) * Math.sin(theta) * speed,
                    life: 1.2 + Math.random() * 0.8
                });
            }
            
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            
            const material = new THREE.PointsMaterial({
                size: 0.2,
                vertexColors: true,
                transparent: true,
                opacity: 1.0,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                sizeAttenuation: true
            });
            
            const firework = new THREE.Points(geometry, material);
            scene.add(firework);
            
            // 霓虹光球效果
            createNeonExplosion(x, y, z, colorScheme[0]);
            
            // 烟花动画
            let age = 0;
            const maxAge = 2.5;
            
            function animateFirework() {
                age += 0.016;
                
                if (age < maxAge) {
                    const positions = firework.geometry.attributes.position.array;
                    
                    for (let i = 0; i < particleCount; i++) {
                        const i3 = i * 3;
                        const lifeProgress = age / velocities[i].life;
                        
                        if (lifeProgress < 1) {
                            positions[i3] += velocities[i].x;
                            positions[i3 + 1] += velocities[i].y;
                            positions[i3 + 2] += velocities[i].z;
                            
                            // 重力和空气阻力
                            velocities[i].y -= 0.015;
                            velocities[i].x *= 0.985;
                            velocities[i].y *= 0.985;
                            velocities[i].z *= 0.985;
                        }
                    }
                    
                    firework.geometry.attributes.position.needsUpdate = true;
                    firework.material.opacity = 1 - Math.pow(age / maxAge, 2);
                    requestAnimationFrame(animateFirework);
                } else {
                    scene.remove(firework);
                    firework.geometry.dispose();
                    firework.material.dispose();
                }
            }
            
            animateFirework();
        }
        
        function createNeonExplosion(x, y, z, color) {
            // 霓虹光球
            const geometry = new THREE.SphereGeometry(1, 32, 32);
            const material = new THREE.MeshBasicMaterial({
                color: color,
                transparent: true,
                opacity: 1.0,
                blending: THREE.AdditiveBlending,
                side: THREE.BackSide
            });
            
            const explosion = new THREE.Mesh(geometry, material);
            explosion.position.set(x, y, z);
            scene.add(explosion);
            
            // 霓虹冲击波
            const waveGeometry = new THREE.RingGeometry(0.1, 1, 32);
            const waveMaterial = new THREE.MeshBasicMaterial({
                color: color,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending,
                side: THREE.DoubleSide
            });
            
            const wave = new THREE.Mesh(waveGeometry, waveMaterial);
            wave.position.set(x, y, z);
            wave.rotation.x = Math.PI / 2;
            scene.add(wave);
            
            let scale = 1;
            let opacity = 1;
            let waveScale = 1;
            let waveOpacity = 0.8;
            
            function animateExplosion() {
                scale += 0.25;
                opacity -= 0.12;
                waveScale += 0.5;
                waveOpacity -= 0.08;
                
                explosion.scale.set(scale, scale, scale);
                explosion.material.opacity = opacity;
                
                wave.scale.set(waveScale, waveScale, 1);
                wave.material.opacity = waveOpacity;
                
                if (opacity > 0) {
                    requestAnimationFrame(animateExplosion);
                } else {
                    scene.remove(explosion);
                    scene.remove(wave);
                    explosion.geometry.dispose();
                    explosion.material.dispose();
                    wave.geometry.dispose();
                    wave.material.dispose();
                }
            }
            
            animateExplosion();
        }
        
        // ====== UI控制 ======
        function updateFireworkCount() {
            document.getElementById('fireworkCount').textContent = fireworkCount;
        }
        
        function updateWish() {
            const wish = wishes[wishIndex];
            document.getElementById('wishTitle').textContent = wish.title;
            document.getElementById('wishContent').textContent = wish.content;
            document.getElementById('wishAuthor').textContent = '- ' + wish.author + ' -';
        }
        
        function nextWish() {
            wishIndex = (wishIndex + 1) % wishes.length;
            updateWish();
            launchNeonFireworks(1);
        }
        
        function applySettings() {
            neonIntensity = parseFloat(document.getElementById('neonIntensitySlider').value);
            ribbonSpeed = parseFloat(document.getElementById('ribbonSpeedSlider').value);
            fuCharacterBrightness = parseFloat(document.getElementById('fuCharacterBrightnessSlider').value);
            glowRadius = parseInt(document.getElementById('glowRadiusSlider').value);
            blinkSpeed = parseFloat(document.getElementById('blinkSpeedSlider').value);
            colorMode = parseInt(document.getElementById('colorModeSlider').value);
            isNeonGlow = document.getElementById('neonGlowToggle').checked;
            isRibbonAnimating = document.getElementById('ribbonAnimationToggle').checked;
            isFuRotating = document.getElementById('fuRotationToggle').checked;
            isBlinking = document.getElementById('blinkToggle').checked;
            isAutoRotating = document.getElementById('autoRotateToggle').checked;
            
            // 更新颜色模式显示
            const colorModeText = ['单色', '多彩', '彩虹'][colorMode - 1];
            document.getElementById('colorModeValue').textContent = colorModeText;
            
            // 更新丝带速度
            neonRibbons.forEach(ribbonData => {
                if (ribbonData.ribbon.userData) {
                    ribbonData.ribbon.userData.rotateSpeed = (0.01 + Math.random() * 0.02) * ribbonSpeed;
                }
                if (ribbonData.knot.userData) {
                    ribbonData.knot.userData.rotateSpeed = (0.02 + Math.random() * 0.03) * ribbonSpeed;
                }
            });
            
            // 更新显示值
            document.getElementById('neonIntensityValue').textContent = neonIntensity.toFixed(1);
            document.getElementById('ribbonSpeedValue').textContent = ribbonSpeed.toFixed(1);
            document.getElementById('fuCharacterBrightnessValue').textContent = fuCharacterBrightness.toFixed(1);
            document.getElementById('glowRadiusValue').textContent = glowRadius;
            document.getElementById('blinkSpeedValue').textContent = blinkSpeed.toFixed(1);
            
            console.log("霓虹设置已应用");
        }
        
        function toggleAutoRotate() {
            isAutoRotating = !isAutoRotating;
            const btn = document.getElementById('rotateBtn');
            const icon = btn.querySelector('i');
            icon.className = isAutoRotating ? 'fas fa-pause' : 'fas fa-play';
        }
        
        function resetView() {
            camera.position.set(0, 20, 45);
            camera.lookAt(0, 0, 0);
            controls.reset();
        }
        
        function toggleMusic() {
            if (!audio) {
                // 初始化音频
                audio = new Audio();
                audio.src = 'https://assets.mixkit.co/music/preview/mixkit-happy-new-year-480.mp3';
                audio.loop = true;
                audio.volume = 0.5;
                audio.play().then(() => {
                    isMusicPlaying = true;
                    updateMusicButton();
                }).catch(e => {
                    console.log("音频播放被阻止:", e);
                });
            } else {
                if (isMusicPlaying) {
                    audio.pause();
                } else {
                    audio.play();
                }
                isMusicPlaying = !isMusicPlaying;
                updateMusicButton();
            }
        }
        
        function toggleNeonMode() {
            isNeonMode = !isNeonMode;
            const btn = document.getElementById('neonBtn');
            const icon = btn.querySelector('i');
            
            if (isNeonMode) {
                icon.className = 'fas fa-lightbulb';
                btn.style.boxShadow = '0 0 30px rgba(255, 0, 255, 0.5)';
            } else {
                icon.className = 'fas fa-lightbulb';
                btn.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.3)';
            }
        }
        
        function updateMusicButton() {
            const btn = document.getElementById('musicBtn');
            if (btn) {
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.className = isMusicPlaying ? 'fas fa-pause' : 'fas fa-play';
                }
            }
        }
        
        // ====== 事件监听 ======
        function setupEventListeners() {
            // 窗口大小调整
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            
            // 滑块实时更新
            document.getElementById('neonIntensitySlider').addEventListener('input', (e) => {
                document.getElementById('neonIntensityValue').textContent = e.target.value;
            });
            
            document.getElementById('ribbonSpeedSlider').addEventListener('input', (e) => {
                document.getElementById('ribbonSpeedValue').textContent = e.target.value;
            });
            
            document.getElementById('fuCharacterBrightnessSlider').addEventListener('input', (e) => {
                document.getElementById('fuCharacterBrightnessValue').textContent = e.target.value;
            });
            
            document.getElementById('glowRadiusSlider').addEventListener('input', (e) => {
                document.getElementById('glowRadiusValue').textContent = e.target.value;
            });
            
            document.getElementById('blinkSpeedSlider').addEventListener('input', (e) => {
                document.getElementById('blinkSpeedValue').textContent = e.target.value;
            });
            
            document.getElementById('colorModeSlider').addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                const text = ['单色', '多彩', '彩虹'][value - 1];
                document.getElementById('colorModeValue').textContent = text;
            });
            
            // 点击场景放烟花
            renderer.domElement.addEventListener('click', (e) => {
                if (e.target === renderer.domElement) {
                    launchNeonFireworks(1);
                }
            });
            
            // 键盘快捷键
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        launchNeonFireworks(3);
                        break;
                    case 'r':
                        resetView();
                        break;
                    case 'm':
                        toggleMusic();
                        break;
                    case 'a':
                        toggleAutoRotate();
                        break;
                    case 'ArrowRight':
                        nextWish();
                        break;
                    case 'n':
                        toggleNeonMode();
                        break;
                    case 'f':
                        // 发射围绕福字的烟花
                        launchFireworksAroundFu();
                        break;
                }
            });
        }
        
        function launchFireworksAroundFu() {
            // 在福字周围发射烟花
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    const angle = (i / 6) * Math.PI * 2;
                    const radius = 5;
                    const x = Math.cos(angle) * radius;
                    const z = Math.sin(angle) * radius;
                    createNeonFirework(x, 15, z, 2);
                    fireworkCount++;
                    updateFireworkCount();
                }, i * 200);
            }
        }
        
        // ====== 动画循环 ======
        function animate() {
            requestAnimationFrame(animate);
            
            const time = Date.now() * 0.001;
            
            // 更新自动旋转
            if (isAutoRotating) {
                controls.autoRotate = true;
                controls.autoRotateSpeed = 0.5;
            } else {
                controls.autoRotate = false;
            }
            
            controls.update();
            
            // 更新灯笼动画
            lanterns.forEach((lantern, index) => {
                if (lantern.userData) {
                    // 摆动效果
                    lantern.rotation.z = Math.sin(time * lantern.userData.swingSpeed + lantern.userData.swingOffset) * 0.3;
                    
                    // 上下浮动
                    lantern.position.y = lantern.userData.originalY + 
                        Math.sin(time * lantern.userData.swingSpeed * 0.7 + lantern.userData.floatOffset) * 1.2;
                    
                    // 缓慢旋转
                    lantern.rotation.y += 0.005 * lantern.userData.rotateSpeed;
                    
                    // 霓虹闪烁效果
                    if (isBlinking) {
                        const pulse = 0.5 + 0.5 * Math.sin(time * lantern.userData.pulseSpeed + lantern.userData.pulseOffset);
                        
                        // 更新灯笼光效
                        lantern.traverse(child => {
                            if (child.material && child.material.emissive) {
                                child.material.emissiveIntensity = neonIntensity * pulse;
                            }
                        });
                        
                        if (lantern.userData.light) {
                            lantern.userData.light.intensity = neonIntensity * 1.5 * pulse;
                        }
                        
                        if (lantern.userData.glow) {
                            lantern.userData.glow.material.opacity = 0.2 * pulse;
                        }
                    }
                    
                    // 更新霓虹倒影
                    if (lantern.userData.reflection && isNeonGlow) {
                        const reflectionData = lantern.userData.reflection.userData;
                        const pulse = Math.sin(time * reflectionData.pulseSpeed + reflectionData.pulseOffset) * 0.2 + 0.8;
                        lantern.userData.reflection.material.opacity = 
                            reflectionData.originalOpacity * neonIntensity * pulse * 0.5;
                        
                        const scale = 1 + Math.sin(time * reflectionData.pulseSpeed * 0.5 + reflectionData.pulseOffset) * 0.2;
                        lantern.userData.reflection.scale.set(scale, scale, scale);
                    }
                    
                    // 更新霓虹激光
                    if (lantern.userData.laser) {
                        const laserData = lantern.userData.laser.userData;
                        const pulse = Math.sin(time * laserData.pulseSpeed + laserData.pulseOffset) * 0.3 + 0.7;
                        lantern.userData.laser.material.opacity = 0.3 * pulse;
                        
                        lantern.userData.laser.rotation.y += 0.01 * laserData.rotateSpeed;
                    }
                }
            });
            
            // 更新福字
            if (fuCharacterGroup) {
                // 福字旋转
                if (isFuRotating) {
                    fuCharacterGroup.rotation.y += fuCharacterGroup.userData.rotateSpeed;
                }
                
                // 福字上下浮动
                const float = Math.sin(time * fuCharacterGroup.userData.floatSpeed + fuCharacterGroup.userData.floatOffset) * 0.3;
                fuCharacterGroup.position.y = 10 + float;
                
                // 福字脉动效果
                if (isBlinking) {
                    const pulse = 0.5 + 0.5 * Math.sin(time * fuCharacterGroup.userData.pulseSpeed + fuCharacterGroup.userData.pulseOffset);
                    
                    // 更新福字所有部分的发光强度
                    fuCharacterGroup.traverse(child => {
                        if (child.material && child.material.emissive) {
                            if (child.material.emissive.getHex() === 0xFF0000) {
                                // 红色部分
                                child.material.emissiveIntensity = fuCharacterBrightness * pulse;
                            } else if (child.material.emissive.getHex() === 0xFFFF00) {
                                // 黄色部分
                                child.material.emissiveIntensity = fuCharacterBrightness * 1.5 * pulse;
                            } else if (child.material.emissive.getHex() === 0xFF00FF) {
                                // 洋红部分
                                child.material.emissiveIntensity = fuCharacterBrightness * pulse;
                            }
                        }
                        
                        // 更新光晕透明度
                        if (child.userData && child.userData.glow) {
                            const glowPulse = 0.2 + 0.1 * Math.sin(time * child.userData.pulseSpeed + child.userData.pulseOffset);
                            child.userData.glow.material.opacity = glowPulse;
                        }
                    });
                }
            }
            
            // 更新霓虹丝带
            if (isRibbonAnimating) {
                neonRibbons.forEach(ribbonData => {
                    const ribbon = ribbonData.ribbon;
                    const glow = ribbonData.glow;
                    const knot = ribbonData.knot;
                    const knotGlow = ribbonData.knotGlow;
                    
                    // 丝带旋转
                    if (ribbon.userData) {
                        // 围绕中心旋转
                        const orbitAngle = time * ribbon.userData.rotateSpeed + ribbon.userData.offset;
                        const orbitRadius = 20;
                        ribbon.position.x = Math.cos(orbitAngle) * orbitRadius;
                        ribbon.position.z = Math.sin(orbitAngle) * orbitRadius;
                        
                        // 保持朝向中心
                        ribbon.lookAt(0, ribbon.position.y, 0);
                        ribbon.rotateY(Math.PI/2); // 调整方向使其正确
                        
                        // 波浪效果
                        const wave = Math.sin(time * ribbon.userData.waveSpeed + ribbon.userData.offset) * ribbon.userData.waveAmplitude;
                        ribbon.rotation.z = wave;
                        
                        // 丝带脉动效果
                        if (isBlinking) {
                            const pulse = 0.7 + 0.3 * Math.sin(time * ribbon.userData.pulseSpeed + ribbon.userData.pulseOffset);
                            ribbon.material.emissiveIntensity = neonIntensity * 0.7 * pulse;
                        }
                    }
                    
                    // 更新丝带光晕位置
                    glow.position.copy(ribbon.position);
                    glow.rotation.copy(ribbon.rotation);
                    
                    // 丝带光晕脉动
                    if (glow.userData && isNeonGlow) {
                        const pulse = Math.sin(time * glow.userData.pulseSpeed + glow.userData.pulseOffset) * 0.2 + 0.8;
                        glow.material.opacity = 0.2 * pulse;
                    }
                    
                    // 丝带结旋转
                    if (knot.userData) {
                        knot.rotation.y += knot.userData.rotateSpeed;
                        knot.rotation.x = Math.sin(time * knot.userData.floatSpeed + knot.userData.offset) * 0.1;
                        
                        // 丝带结脉动
                        if (isBlinking) {
                            const pulse = 0.5 + 0.5 * Math.sin(time * knot.userData.pulseSpeed + knot.userData.pulseOffset);
                            knot.material.emissiveIntensity = neonIntensity * pulse;
                        }
                    }
                    
                    // 丝带结光晕脉动
                    if (knotGlow.userData && isNeonGlow) {
                        const pulse = Math.sin(time * knotGlow.userData.pulseSpeed + knotGlow.userData.pulseOffset) * 0.2 + 0.8;
                        knotGlow.material.opacity = 0.3 * pulse;
                        
                        knotGlow.rotation.y = knot.rotation.y;
                        knotGlow.position.y = knot.position.y;
                    }
                });
            }
            
            // 更新霓虹粒子
            neonParticles.forEach(particles => {
                if (particles.isPoints) {
                    const sizes = particles.geometry.attributes.size.array;
                    const userData = particles.userData;
                    
                    for (let i = 0; i < sizes.length; i++) {
                        const pulse = Math.sin(time * userData.pulseSpeeds[i] + userData.pulseOffsets[i]) * 0.3 + 0.7;
                        sizes[i] = userData.originalSizes[i] * pulse;
                        
                        // 粒子轨道运动
                        const positions = particles.geometry.attributes.position.array;
                        const i3 = i * 3;
                        
                        const angle = userData.orbitAngles[i] + time * userData.orbitSpeeds[i];
                        const radius = Math.sqrt(positions[i3] * positions[i3] + positions[i3 + 2] * positions[i3 + 2]);
                        
                        positions[i3] = Math.cos(angle) * radius;
                        positions[i3 + 2] = Math.sin(angle) * radius;
                        
                        // 上下浮动
                        positions[i3 + 1] += Math.sin(time * userData.floatSpeeds[i]) * 0.01;
                    }
                    
                    particles.geometry.attributes.size.needsUpdate = true;
                    particles.geometry.attributes.position.needsUpdate = true;
                }
                
                if (particles.userData && particles.userData.pulseSpeed) {
                    const pulse = Math.sin(time * particles.userData.pulseSpeed + particles.userData.pulseOffset) * 0.3 + 0.7;
                    particles.material.opacity = 0.2 * pulse;
                    
                    if (particles.userData.rotateSpeed) {
                        particles.rotation.y += 0.01 * particles.userData.rotateSpeed;
                    }
                }
            });
            
            // 更新霓虹灯光
            neonLights.forEach(light => {
                if (light.userData) {
                    const pulse = Math.sin(time * light.userData.pulseSpeed + light.userData.pulseOffset) * 0.3 + 0.7;
                    light.intensity = 0.8 * pulse;
                    
                    // 上下浮动
                    light.position.y = light.userData.originalY + Math.sin(time * 0.3) * 2;
                }
            });
            
            renderer.render(scene, camera);
        }
        
        // ====== 启动 ======
        window.addEventListener('load', init);
    </script>
</body>
</html>